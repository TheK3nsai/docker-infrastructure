# InvoicePlane 1.7.0 - Open Source Invoicing
# ~/docker/invoiceplane/docker-compose.yml
# Uses init container to download 1.7.0 and shared-apache for serving

services:
  # Init container - downloads InvoicePlane 1.7.0 and sets up code
  invoiceplane-init:
    image: alpine:3.21
    container_name: invoiceplane-init
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        echo "Checking InvoicePlane installation..."

        # Check if already installed
        if [ -f /shared-code/index.php ] && [ -f /shared-code/.version ] && [ "$$(cat /shared-code/.version)" = "1.7.0" ]; then
            echo "InvoicePlane 1.7.0 already installed"
        else
            echo "Downloading InvoicePlane 1.7.0..."
            apk add --no-cache unzip

            # Download release (wget is built into alpine busybox)
            wget -q -O /tmp/invoiceplane.zip https://github.com/InvoicePlane/InvoicePlane/releases/download/v1.7.0/v1.7.0.zip

            # Extract to shared volume
            echo "Extracting..."
            unzip -q /tmp/invoiceplane.zip -d /tmp/

            # Copy files (the zip extracts to 'ip' directory)
            cp -a /tmp/ip/. /shared-code/

            # Mark version
            echo "1.7.0" > /shared-code/.version

            # Cleanup
            rm -rf /tmp/invoiceplane.zip /tmp/ip

            echo "InvoicePlane 1.7.0 installed"
        fi

        # Ensure ipconfig.php exists
        if [ ! -f /shared-code/ipconfig.php ] && [ -f /shared-code/ipconfig.php.example ]; then
            cp /shared-code/ipconfig.php.example /shared-code/ipconfig.php
            echo "Created ipconfig.php from example"
        fi

        # Set permissions
        echo "Setting permissions..."
        chown -R 33:33 /shared-code
        chmod -R o+rX /shared-code

        # Ensure uploads directory exists and is writable
        mkdir -p /shared-code/uploads
        chmod 775 /shared-code/uploads

        echo "Init complete"
    volumes:
      - invoiceplane-code:/shared-code
    networks:
      - shared-db
    restart: "no"

  # PHP-FPM container
  invoiceplane:
    build:
      context: .
      dockerfile: Dockerfile
    image: invoiceplane-fpm:1.7.0
    container_name: invoiceplane
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 384m
        reservations:
          memory: 192m
    volumes:
      - invoiceplane-code:/var/www/invoiceplane
      - invoiceplane-uploads:/var/www/invoiceplane/uploads
    environment:
      - TZ=UTC
    depends_on:
      invoiceplane-init:
        condition: service_completed_successfully
    networks:
      - shared-db

volumes:
  invoiceplane-code:
  invoiceplane-uploads:

networks:
  shared-db:
    external: true
