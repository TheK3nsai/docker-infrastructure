name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: disable, truthy: disable}}" \
            traefik/*.yml \
            */docker-compose.yml

  docker-compose-validate:
    name: Docker Compose Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate traefik
        run: docker compose -f traefik/docker-compose.yml config --quiet

      - name: Validate shared-services
        run: docker compose -f shared-services/docker-compose.yml config --quiet

      - name: Validate nextcloud
        run: docker compose -f nextcloud/docker-compose.yml config --quiet

      - name: Validate zammad
        run: docker compose -f zammad/docker-compose.yml config --quiet

  secrets-check:
    name: Check for Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for .env files
        run: |
          if find . -name ".env" -not -name ".env.example" | grep -q .; then
            echo "ERROR: .env files should not be committed"
            find . -name ".env" -not -name ".env.example"
            exit 1
          fi

      - name: Check for hardcoded passwords in SQL
        run: |
          if find . -path "./shared-services/init-scripts/*.sql" -not -name "*.example" | grep -q .; then
            echo "ERROR: SQL init scripts with passwords should not be committed"
            echo "Use .sql.example files instead"
            exit 1
          fi
