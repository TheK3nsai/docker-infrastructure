# Zammad Docker Compose - Using Shared PostgreSQL + Redis + Nginx
# ~/docker/zammad/docker-compose.yml

x-zammad-service: &zammad-service
  image: ${IMAGE_REPO:-ghcr.io/zammad/zammad}:${VERSION:-6.5.2-55}
  restart: ${RESTART:-unless-stopped}
  environment: &zammad-environment
    POSTGRESQL_HOST: shared-postgres
    POSTGRESQL_USER: ${POSTGRES_USER:-zammad}
    POSTGRESQL_PASS: ${POSTGRES_PASS}
    POSTGRESQL_DB: ${POSTGRES_DB:-zammad}
    MEMCACHE_SERVERS: ${MEMCACHE_SERVERS:-zammad-memcached:11211}
    REDIS_URL: redis://shared-redis:6379/2
    ELASTICSEARCH_HOST: zammad-elasticsearch
    ELASTICSEARCH_PORT: 9200
    ZAMMAD_HTTP_TYPE: https
    ZAMMAD_FQDN: tickets.kensai.cloud
  volumes:
    - zammad-storage:/opt/zammad/storage
  depends_on:
    - zammad-memcached
  networks:
    - zammad-internal
    - shared-db

services:
  zammad-elasticsearch:
    image: elasticsearch:${ELASTICSEARCH_VERSION:-8.18.0}
    container_name: zammad-elasticsearch
    restart: ${RESTART:-unless-stopped}
    deploy:
      resources:
        limits:
          memory: 1200m
        reservations:
          memory: 768m
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: ${ELASTICSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}
    volumes:
      - zammad-es:/usr/share/elasticsearch/data
    networks:
      - zammad-internal

  zammad-memcached:
    image: memcached:${MEMCACHE_VERSION:-1.6-alpine}
    container_name: zammad-memcached
    restart: ${RESTART:-unless-stopped}
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 96m
    command: memcached -m 64
    networks:
      - zammad-internal

  zammad-init:
    <<: *zammad-service
    container_name: zammad-init
    command: ["zammad-init"]
    restart: on-failure
    user: 0:0
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
    depends_on:
      - zammad-elasticsearch
      - zammad-memcached

  zammad-railsserver:
    <<: *zammad-service
    container_name: zammad-railsserver
    command: ["zammad-railsserver"]
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
    depends_on:
      - zammad-init
    networks:
      - zammad-internal
      - shared-db
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.zammad.rule=Host(`tickets.kensai.cloud`)"
      - "traefik.http.routers.zammad.entrypoints=websecure"
      - "traefik.http.routers.zammad.tls.certresolver=letsencrypt"
      - "traefik.http.routers.zammad.middlewares=security-headers@file"
      - "traefik.http.services.zammad.loadbalancer.server.port=3000"

  zammad-scheduler:
    <<: *zammad-service
    container_name: zammad-scheduler
    command: ["zammad-scheduler"]
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
    depends_on:
      - zammad-init

  zammad-websocket:
    <<: *zammad-service
    container_name: zammad-websocket
    command: ["zammad-websocket"]
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
    depends_on:
      - zammad-init
    networks:
      - zammad-internal
      - shared-db
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.zammad-ws.rule=Host(`tickets.kensai.cloud`) && Path(`/ws`)"
      - "traefik.http.routers.zammad-ws.entrypoints=websecure"
      - "traefik.http.routers.zammad-ws.tls.certresolver=letsencrypt"
      - "traefik.http.services.zammad-ws.loadbalancer.server.port=6042"

  # zammad-nginx disabled - Traefik connects directly to railsserver/websocket
  # zammad-nginx:
  #   <<: *zammad-service
  #   container_name: zammad-nginx
  #   command: ["zammad-nginx"]
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 256m
  #       reservations:
  #         memory: 128m
  #   expose:
  #     - "8080"
  #   depends_on:
  #     - zammad-railsserver
  #   networks:
  #     - zammad-internal

volumes:
  zammad-es:
  zammad-storage:

networks:
  zammad-internal:
  shared-db:
    external: true
  traefik-net:
    external: true
